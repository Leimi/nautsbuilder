/* Nautsbuilder - Awesomenauts build maker v0.12.0 - https://github.com/Leimi/awesomenauts-build-maker
* Copyright (c) 2014 Emmanuel Pelletier
* This Source Code Form is subject to the terms of the Mozilla Public License, v2.0. If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/. */_.mixin({capitalized:function(a){return _.isString(a)?a.replace(/_/g," ").replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()}):!1},underscored:function(a){return _.isString(a)?a.replace(/[\s]+/g,"_"):!1},ununderscored:function(a){return _.isString(a)?a.replace(/_/g," "):!1},trim:function(a,b){if(!a)return"";if(b=b||null,"function"!=typeof String.prototype.trim||b){var c=b?b:"\\s";return String(a).replace(new RegExp("^"+c+"+|"+c+"+$","g"),"")}return a.trim()},italics:function(a){return a?a.replace(/\n/g,"<br>").replace(/\*(.*)\*/,"<em>$1</em>"):""}}),Backbone.View.prototype.assign=function(a,b){a.setElement(this.$(b)).render()},Backbone.Model.prototype.toJSON=function(){return _.extend({},_.clone(this.attributes),{cid:this.cid})},window.leiminauts=window.leiminauts||{},leiminauts.utils={treatEffects:function(a){var b=[];if(!_(a).isString())return a;var c=a.toLowerCase().split(";");return _(c).each(function(a,d){attribute=_(a).trim().split(":"),attribute[0]=_(attribute[0]).trim(),attribute[1]=_(attribute[1]).trim(),attribute[0]||attribute[1]?b.push({key:attribute[0],value:attribute[1]}):c.splice(d,1)},this),b},number:function(a,b){return a=1*a,_(a).isNaN()?a:(b=b||2,0!==a%1?a.toFixed(b):a)},dps:function(a,b){return leiminauts.utils.number((parseFloat(b)/60*parseFloat(a)).toFixed(2))}},leiminauts.Character=Backbone.Model.extend({initialize:function(){this.skills=this.get("skills"),this.set("total_cost",0),this.set("maxed_out",!1),this.set("level",1),this.listenTo(this.skills,"change:total_cost",this.onCostChange),this.listenTo(this.skills,"change:maxed_out",this.onSkillComplete),this.on("change:selected",this.onSelectedChange,this)},onCostChange:function(){var a=0;this.skills.each(function(b){a+=b.get("total_cost")}),this.set("level",Math.floor((a-100)/100)<=1?1:Math.floor((a-100)/100)),this.set("total_cost",a)},onSkillComplete:function(){var a=!0;_(this.skills.pluck("maxed_out")).each(function(b){return b?void 0:(a=!1,!1)}),this.set("maxed_out",a)},onSelectedChange:function(){this.skills.each(function(a){a.set("selected",this.get("selected"))},this)},reset:function(){this.skills.each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)},this)}}),leiminauts.CharactersData=Backbone.Collection.extend({model:leiminauts.Character,initialize:function(a,b){void 0!==b.data&&(this.data=b.data,this.console=b.console||!1,this.data&&(leiminauts.characters=this.data.characters,leiminauts.skills=this.data.skills,leiminauts.upgrades=this.data.upgrades,_.each(leiminauts.characters,function(a){var b=_(leiminauts.skills).where({character:a.name});a.skills=new leiminauts.Skills(b),this.add(a)},this)))}}),leiminauts.Skill=Backbone.Model.extend({initialize:function(){this.set("upgrades",new leiminauts.Upgrades),this.upgrades=this.get("upgrades"),this.on("change:selected",this.onSelectedChange,this)},onSelectedChange:function(){this.get("selected")?(this.upgrades.on("change",this.updateEffects,this),this.on("change:active",this.updateEffects,this),this.on("change:active",this.resetUpgradesState,this)):(this.upgrades.off("change",this.updateEffects,this),this.off("change:active",this.updateEffects,this),this.off("change:active",this.resetUpgradesState,this)),this.get("selected")&&this.get("upgrades").length<=0&&(this.set("maxed_out",!1),this._originalEffects=this.get("effects"),this.prepareBaseEffects(),this.initUpgrades(),this.set("total_cost",0),this.set("active",void 0!==this.get("cost")&&this.get("cost")<=0),this.set("toggable",!this.get("active")))},initUpgrades:function(){var a=[];if("jump"==this.get("type")){a=_(leiminauts.upgrades).where({skill:"Jump"});var b=leiminauts.utils.treatEffects(this.get("effects")),c=_(b).findWhere({key:"pills"}),d=[];d=c&&"light"==c.value?["Power Pills Turbo","Power Pills Companion"]:c&&"companion"==c.value?["Power Pills Light","Power Pills Turbo"]:["Power Pills Light","Power Pills Companion"],_(d).each(function(b){a.splice(_(a).indexOf(_(a).findWhere({name:b})),1)});var e=leiminauts.utils.treatEffects(this._originalEffects);e.splice(_(e).indexOf(_(e).findWhere({key:"pills"})),1);var f=_(leiminauts.upgrades).where({skill:this.get("name")});_(a).each(function(b,c){_(f).each(function(d){d.replaces==b.name&&(a[c]=_(d).clone())})})}else a=_(leiminauts.upgrades).where({skill:this.get("name")}),_(a).each(function(a){a.skill=this},this);this.get("upgrades").reset(a),this.resetUpgradesState()},setActive:function(a){this.get("toggable")&&this.set("active",!!a)},resetUpgradesState:function(a){a=void 0!==a?a:!this.get("active"),this.upgrades.each(function(b){b.setStep(0),b.set("locked",a)},this),this.set("maxed_out",!1)},getActiveUpgrades:function(){var a=this.upgrades.filter(function(a){return a.get("active")===!0});return a},getActiveSteps:function(){var a=[];return this.upgrades.each(function(b){b.get("active")===!0&&a.push(b.get("current_step"))}),a},updateEffects:function(){if(!this.get("selected"))return!1;if(!this.get("active"))return this.set("effects",[]),this.set("total_cost",0),!1;var a=this.getActiveUpgrades(),b=!0;a.length>=3?_(a).each(function(a){return a.get("current_step").get("level")!==a.get("max_step")?(b=!1,!1):void 0}):b=!1,this.set("maxed_out",b);var c=this.getActiveSteps();this.upgrades.each(function(b){this.get("active")&&b.set("locked",a.length>=3&&!_(a).contains(b))},this);var d=parseInt(this.get("cost"),10);_(a).each(function(a){d+=a.get("current_step").get("level")*a.get("cost")}),this.set("total_cost",d),this.set("effects",[],{silent:!0});var e={},f=[],g=function(a){_(a).each(function(b){var c=b.value;a===f||"/"!=c.toString().charAt(0)||_(parseFloat(c.substr(1))).isNaN()?void 0!==e[b.key]?e[b.key].push(b.value):e[b.key]=[b.value]:f.push({key:b.key,value:c})})};g(this.get("baseEffects")),_(c).each(function(a){g(a.get("attrs"))}),g(f);var h=/^(\+|-|\/|@)?([0-9]+[\.,]?[0-9]*)([%s])?$/i;_(e).each(function(a,b){var c="",d=!1;_(a).each(function(b){if(regexRes=h.exec(b),null!==regexRes){var e=!0,f=parseFloat(c);_(f).isNaN()&&(f=0),regexRes[3]&&"%"==regexRes[3]&&0!==f&&"%"!=a[0].substr(-1)?(f+=parseFloat(a[0])*(parseFloat(b)/100),e=!1):regexRes[1]&&"/"==regexRes[1]?f/=parseFloat(b.substr(1)):regexRes[1]&&"@"==regexRes[1]?f=parseFloat(b.substr(1)):f+=parseFloat(b),f=leiminauts.utils.number(f),c=f,regexRes[3]&&e&&(c+=regexRes[3]),regexRes[1]&&"+"==regexRes[1]&&f>0&&(!d||0===d.toString().indexOf("+"))&&(c="+"+c)}else c=b;d=c}),this.get("effects").push({key:b,value:c})},this),this.setSpecificEffects(),this.setDPS(),this.setSpecificEffectsTheReturnOfTheRevenge(),this.set("effects",_(this.get("effects")).sortBy(function(a){return a.key.toLowerCase()}))},prepareBaseEffects:function(){if(!this.get("selected"))return!1;if(!_(this.get("effects")).isString())return!1;if(this.set("baseEffects",leiminauts.utils.treatEffects(this.get("effects"))),"jump"==this.get("type")){var a=_(this.get("baseEffects"));a.splice(_(a).indexOf(_(a).findWhere({key:"pills"})),1);var b=a.findWhere({key:"solar"}),c=a.findWhere({key:"solar per min"});b||a.push({key:"solar",value:235}),c||a.push({key:"solar per min",value:30})}},setSpecificEffects:function(){if(!this.get("selected"))return!1;var a=_(this.get("effects")),b=0,c=0,d=[];if("Bolt .45 Fish-gun"==this.get("name")&&d.push("bonus damage"),"Bubble Gun"==this.get("name")&&d.push("yakoiza damage","godfish damage"),"Chain whack"==this.get("name")&&d.push("ion blowtorch damage"),_(d).each(function(b){var c=a.findWhere({key:b});c&&(bonusDmgVal=this.bonusDamage(a.findWhere({key:"damage"}),b,a),c.value=bonusDmgVal)},this),"Missiles"==this.get("name")){var e=[],f=a.findWhere({key:"damage"}).value;_(4).times(function(){e.push(f)});var g=a.filter(function(a){return/^missile [0-9]$/.test(a.key)});for(_(g).each(function(b){var c=parseInt(b.key.substr(-1),10)-1;e[c]=(f+4*c)*parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)});e.length>1&&e[e.length-1]==f;)e.pop();b=_(e).reduce(function(a,b){return a+b},0)/e.length,a.findWhere({key:"damage"}).value=e.join(" > "),1!==e.length&&b!==e[0]&&a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if("Bash"==this.get("name")){var h=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > "),i=a.filter(function(a){return/^punch [0-9]$/.test(a.key)});_(i).each(function(b){var c=parseInt(b.key.substr(-1),10)-1;h[c]=1*h[c]+parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)}),b=_(h).reduce(function(a,b){return a+1*b},0)/h.length,a.findWhere({key:"damage"}).value=h.join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if("Slash"==this.get("name")){var j,k,l=this.getActiveUpgrade("clover of honour"),m=this.getActiveUpgrade("backstab blade");c=a.findWhere({key:"damage"}),m&&(j=this.bonusDamage(c,"backstab damage",a),k=a.findWhere({key:"backstab damage"}),k&&(k.value=j)),l&&(cloverDmg=this.bonusDamage(c,"3rd hit damage",a),b=(2*c.value+cloverDmg)/3,c.value=[1*c.value,1*c.value,cloverDmg].join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)}),m&&k&&(cloverDmgBs=this.bonusDamage(j,"3rd hit damage",a),k.value=[1*j,1*j,cloverDmgBs].join(" > "),j=(2*j+cloverDmgBs)/3,a.push({key:"avg backstab damage",value:leiminauts.utils.number(j)})),a.splice(_(a).indexOf(_(a).findWhere({key:"3rd hit damage"})),1))}if("Laser"==this.get("name")){var n=a.findWhere({key:"damage"}).value,o=a.findWhere({key:"max damage"}).value,p=[];_(o-n).times(function(a){p.push(a+n)});var q=a.findWhere({key:"attack speed"}).value/60,r=1*a.findWhere({key:"time to next charge"}).value.replace("s",""),s=q*r,t=0;c=0,_(p).each(function(a){c+=s*a,t+=r});var u=c/t;a.push({key:"DPS until max",value:leiminauts.utils.number(u)}),a.push({key:"DPS max",value:leiminauts.utils.number(q*o)})}if("Spike Dive"==this.get("name")){c=a.findWhere({key:"damage"}).value;var v=this.getActiveUpgrade("dead seahorse head"),w=null,x=a.findWhere({key:"extra spike damage"});x=x?parseInt(x.value,10):null,v&&x&&(a.splice(_(a).indexOf(_(a).findWhere({key:"extra spike"})),1),a.splice(_(a).indexOf(_(a).findWhere({key:"extra spike damage"})),1),w={key:"Extra Spike",value:c*x/100},a.push(w));var y=this.getActiveUpgrade("bag full of gold fish"),z=a.findWhere({key:"damage with 150 solar"});y&&z&&(z.value=1*z.value+c,w&&a.push({key:"Extra Spike With 150 Solar",value:Math.floor(z.value*x/100)}))}if("Evil Eye"==this.get("name")){var A=this.getActiveUpgrade("toothbrush shank");if(A&&(c=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > "),toothbrushVal=A.get("current_step").get("level")>0?A.get("current_step").get("attrs"):null)){var B=parseInt(_(toothbrushVal).findWhere({key:"damage"}).value,10),C=[];_(c).each(function(a){C.push(1*a/100*1*B+1*a)}),a.findWhere({key:"damage"}).value=C.join(" > ")}}},setDPS:function(){if(!this.get("selected"))return!1;if("Laser"==this.get("name"))return!1;var a=_(this.get("effects")),b=a.findWhere({key:"attack speed"}),c=a.findWhere({key:"avg damage"});c||(c=a.findWhere({key:"damage"}));var d=a.findWhere({key:"DPS"});b&&c&&(dpsVal=leiminauts.utils.dps(c.value,b.value),d?d.value=dpsVal:(d={key:"DPS",value:dpsVal},a.push(d)));var e=a.findWhere({key:"damage over time"}),f=a.findWhere({key:"damage duration"});if(e&&f&&a.push({key:"DOT DPS",value:leiminauts.utils.number(e.value/f.value.replace("s",""))}),"auto"===this.get("type")){var g={damage:[],attackSpeed:[]},h=["storm","bonus","avg","turret","yakoiza","grenade","snipe","min","max","droid"];a.each(function(a){var b=!1;if(_(h).each(function(c){0===a.key.toLowerCase().indexOf(c)&&(b=!0)}),b)return!1;var c=a.key.match(/(.+) damage/i),d=a.key.match(/(.+) attack speed/i);c&&g.damage.push(c[1]),d&&g.attackSpeed.push(d[1])});var i=d?+d.value:0,j=_.union(g.damage,g.attackSpeed);_(j).each(function(b){var c;c=a.findWhere({key:"avg "+b+" damage"})?a.findWhere({key:"avg "+b+" damage"}):a.findWhere({key:b+" damage"})?a.findWhere({key:b+" damage"}):a.findWhere({key:"damage"});var d=a.findWhere({key:b+" attack speed"})?a.findWhere({key:b+" attack speed"}):a.findWhere({key:"attack speed"}),e={key:b+" DPS",value:leiminauts.utils.dps(c.value,d.value)};i+=+e.value,a.push(e)}),j.length&&d&&i!==d.value&&!_(["Slash","Bubble Gun","Chain whack"]).contains(this.get("name"))&&a.push({key:"total DPS",value:leiminauts.utils.number(i)})}},setSpecificEffectsTheReturnOfTheRevenge:function(){if(!this.get("selected"))return!1;var a=_(this.get("effects"));a.each(function(b){var c=b.key.match(/(.+) multiplier/i);c&&b.value&&(a.splice(a.indexOf(b),1),this.multiplyEffect(b.value,a,c[1]),"Bubble Gun"==this.get("name")&&(this.multiplyEffect(b.value,a,"godfish damage"),this.multiplyEffect(b.value,a,"yakoiza damage")))},this)},multiplyEffect:function(a,b,c){c=c||"damage";var d=b.findWhere({key:c});d&&(d.value=leiminauts.utils.number(d.value*a)+"&nbsp; ( "+d.value+"×"+a+" )");var e="damage".length;if("damage"===c.substr(-e)){var f=c.substr(0,c.length-e),g=b.findWhere({key:f+"DPS"});g&&(g.value=leiminauts.utils.number(g.value*a)+"&nbsp; ( "+g.value+"×"+a+" )")}},bonusDamage:function(a,b,c){var d=parseFloat(a&&a.value?a.value:a),e=c.findWhere({key:b});return e=e?e.value:0,d+1*e},getActiveUpgrade:function(a){var b=_(this.getActiveUpgrades()).filter(function(b){return b.get("name").toLowerCase()==a.toLowerCase()});return b.length?b[0]:!1}}),leiminauts.Skills=Backbone.Collection.extend({model:leiminauts.Skill}),leiminauts.Upgrade=Backbone.Model.extend({defaults:{current_step:null,max_step:0,active:!1,locked:!1},initialize:function(){var a=_(this.attributes).filter(function(a,b){return/^step[0-9]$/.test(b)&&""!==_.trim(a)}),b=new leiminauts.Steps([new leiminauts.Step({upgrade:this.toJSON()})]);_(a).each(function(a,c){b.add({level:c+1,description:a,upgrade:this.toJSON()})},this),this.set("steps",b),this.set("max_step",b.size()-1),this.set("description",_(this.get("description").replace(/\n/g,"<br>")).italics()),this.setStep(0)},setStep:function(a){a=parseInt(a,10),a>this.get("max_step")&&(a=this.get("max_step")),0>a&&(a=0);var b=this.get("steps").findWhere({level:a});this.set("current_step",b),this.set("active",b.get("level")>0)}}),leiminauts.Upgrades=Backbone.Collection.extend({model:leiminauts.Upgrade}),leiminauts.Step=Backbone.Model.extend({defaults:{level:0,description:""},initialize:function(){this.set("attrs",leiminauts.utils.treatEffects(this.get("description"))),this.updateDescription()},updateDescription:function(){this.set("description",this.get("description").replace(/: @/g,": "))}}),leiminauts.Steps=Backbone.Collection.extend({model:leiminauts.Step}),leiminauts.Favorites=Backbone.Collection.extend({initialize:function(a,b){this.options=_(b).defaults(this.defaults),this.localStorage=new Backbone.LocalStorage("nautsbuilder.favorites"),this.fetch()},addToStorage:function(a){var b=this.findWhere({hash:a.hash});b?this.get(b).save(a):this.create(a)},removeFromStorage:function(a){a.destroy(),this.remove(a)},toggle:function(a){var b=this.findWhere({hash:a.hash});return b?this.removeFromStorage(b):this.addToStorage(a)}}),leiminauts.CharactersView=Backbone.View.extend({className:"chars-list-container",events:{"click .char[data-id]":"selectCharacter"},initialize:function(){this.template=_.template($("#chars-tpl").html()),this.listenTo(this.collection,"add remove reset",this.render),void 0!==this.options.character&&(this.character=this.options.character.model.toJSON()),this.console=void 0!==this.options.console?this.options.console:!1,this.currentChar=null,this.mouseOverTimeout=null,this.mini=this.options.mini||!1,this.$el.on("mouseover",".char",_.bind(_.debounce(this.showCharInfo,50),this)),this.$el.on("click",".current-char",_.bind(this.reset,this))},render:function(a){a=_.extend({},{currentCharOnly:!1},a||{});var b=this.template({characters:this.collection.toJSON(),currentChar:this.currentChar,character:this.character,console:this.options.console,mini:this.mini});return a.currentCharOnly?this.$(".current-char").html($($.parseHTML("<div>"+b+"</div>")).find(".current-char").html()):this.$el.html(b),this},selectCharacter:function(a){this.collection.trigger("selected",$(a.currentTarget).attr("data-id"))},showCharInfo:function(a){if(this.character)return!1;var b=$(a.currentTarget).attr("data-char");!b||this.currentChar&&this.currentChar.get("name")===b||(this.currentChar=this.collection.findWhere({name:b}),this.render({currentCharOnly:!0}))},reset:function(){this.currentChar=null,this.render()}}),leiminauts.CharacterView=Backbone.View.extend({tagName:"div",className:"char-builder",events:{"click .char-forum-switch button":"toggleForumViews"},initialize:function(a){_.defaults(a,{build:null,order:null,info:null,console:!1,forum:!1,favorites:!1}),this.template=_.template($("#char-tpl").html()),this.console=a.console,this.forum=a.forum,this.favorites=a.favorites,this.characters=new leiminauts.CharactersView({character:this,collection:this.collection,console:this.console,mini:!0}),this.build=new leiminauts.BuildView({character:this,forum:this.forum}),this.info=new leiminauts.InfoView({character:this,forum:this.forum,favorites:this.favorites}),this.order=new leiminauts.OrderView({character:this,forum:this.forum}),this.subViews=[this.characters,this.build,this.info,this.order],this.order.on("changed",function(a){this.trigger("order:changed",a),this.toggleForumTabs()},this),this.order.on("toggled",function(){this.trigger("order:toggled"),this.toggleForumTabs()},this),this.forum&&this.order.collection.on("all",this.toggleForumTabs,this),this.render(),this.toggleTimeout=null,this.listenTo(this.model,"change:maxed_out",this.toggleMaxedOutView)},remove:function(){_(this.subViews).each(function(a){a.remove()}),Backbone.View.prototype.remove.call(this)},render:function(){var a=this.model.toJSON();return a.console=this.console,a.forum=this.forum,this.$el.html(this.template(a)),this.assign(this.characters,".chars"),this.assign(this.build,".build"),this.assign(this.info,".char-info"),this.assign(this.order,".order"),this.forum&&this.toggleForumViews(null,"build"),this},toggleMaxedOutView:function(){if(!this.forum){var a=Modernizr.csstransitions?500:0;this.model.get("maxed_out")?this.toggleTimeout=setTimeout(_.bind(function(){this.$(".upgrade:not(.active)").addClass("hidden")},this),a):(clearTimeout(this.toggleTimeout),this.$(".upgrade:not(.active)").removeClass("hidden"))}setTimeout(_.bind(function(){this.$el.toggleClass("maxed-out",this.model.get("maxed_out")),this.$(".forum-snippet").attr("rows",this.model.get("maxed_out")?6:1)},this),0)},toggleForumViews:function(a,b){b=b||null,itemClass=b?b:$(a.currentTarget).attr("data-item"),this.$(".char-forum-switch button").removeClass("switch-active"),a&&$(a.currentTarget).addClass("switch-active"),b&&this.$('.char-forum-switch button[data-item="'+b+'"]').addClass("switch-active"),this.$(".build").toggleClass("forum-hidden","build"!=itemClass),this.$(".order").toggleClass("forum-hidden","order"!=itemClass)},toggleForumTabs:function(){this.$(".char-forum-switch").toggleClass("forum-hidden",!this.order.active)}}),leiminauts.BuildView=Backbone.View.extend({tagName:"div",className:"build",events:{"click .build-cancel":"reset"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.forum=this.options.forum||!1,this.skills=[],this.model.get("skills").each(function(a){this.skills.push(new leiminauts.SkillView({model:a,forum:this.forum}))},this),this.template=_.template($("#build-tpl").html()),this.listenTo(this.model.get("skills"),"change:active",this.toggleResetButtonClass),this.model.get("skills").each(function(a){this.listenTo(a.get("upgrades"),"change:active",this.toggleResetButtonClass)},this),this.toggleResetButtonClass()},toggleResetButtonClass:function(){if(!this.$resetButton)return!1;var a=!1;this.model.get("skills").each(function(b){return b.get("active")&&b.get("toggable")||b.getActiveUpgrades().length>0?(a=!0,!1):void 0}),this.$resetButton.toggleClass("active",a)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$resetButton=this.$(".build-cancel"),_(this.skills).each(function(a){a.delegateEvents(),this.$el.append(a.render().el)},this),this},reset:function(){this.model.get("skills").each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)})}}),leiminauts.OrderView=Backbone.View.extend({tagName:"div",className:"order",initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.template=_.template($("#order-tpl").html()),this.active=!0,this.forum=this.options.forum,this.on("toggled",this.toggleView,this),this.collection=new Backbone.Collection(null,{comparator:this.comparator}),this.collection.on("reset",this.onBuildChange,this),this.model.get("skills").each(function(a){this.listenTo(a.get("upgrades"),"change:current_step",this.onBuildChange)},this),this.listenTo(this.model.get("skills"),"change:active",this.onBuildChange),this.listenTo(this.model,"change:selected",this.onSelectedChange),this.on("sorted",this.render,this)},toggle:function(){this.active=!this.active,this.trigger("toggled")},toggleView:function(){return this.$el?(this.$el.find("ul").toggleClass("hidden",!this.active),this.$el.find('input[name="active"]').prop("checked",this.active),void 0):!1},onBuildChange:function(a){this.updateCollection(a),this.render()},onSelectedChange:function(){this.model.get("selected")||this.collection.reset()},comparator:function(a){return a.get("order")||0},render:function(){var a=this.collection.toJSON(),b=0;return _(a).each(function(a){b+=a.upgrade?1*a.upgrade.cost:1*a.cost,a.order_total_cost=b,a.order_req_lvl=Math.floor((b-100)/100)<=1?1:Math.floor((b-100)/100)}),this.$el.html(this.template({items:a,active:this.active,forum:this.forum})),this.$(".order-item").on("mouseover mouseout click dragstart",this.handleTooltip),this.forum||(this.$('input[name="active"]').on("change",_.bind(this.toggle,this)),this.$list=this.$el.children("ul").first(),this.$list.sortable({items:".order-item"}),this.$list.on("sortupdate",_.bind(this.updateOrder,this))),this.toggleView(),this},updateCollection:function(a){if(a instanceof leiminauts.Skill)a.get("active")?this.collection.add(a,{sort:!1}):this.collection.remove(a);else if(a instanceof leiminauts.Upgrade){var b=a.get("current_step").get("level"),c=this.collection.filter(function(b){return b instanceof leiminauts.Step&&b.get("upgrade").name==a.get("name")});if(0!==b)if(b>1&&!c.length){var d=[];a.get("steps").each(function(a){a.get("level")<b&&d.push(a)}),this.collection.add(d,{sort:!1})}else this.collection.add(a.get("current_step"),{sort:!1});else this.collection.remove(c)}this.active&&this.trigger("changed",this.collection)},updateOrder:function(){return this.$list?(this.$list.children().each(_.bind(function(a,b){this.collection.get($(b).attr("data-cid")).set("order",a,{silent:!0})},this)),this.collection.sort(),this.active&&(this.trigger("changed",this.collection),this.trigger("sorted",this.collection)),!1):!1},handleTooltip:function(a){"mouseover"==a.type?MouseTooltip.show($(a.currentTarget).find(".order-popup").html()):MouseTooltip.hide()}}),leiminauts.InfoView=Backbone.View.extend({tagName:"div",className:"char-info",events:{"click .forum-snippet":"focusForumSnippet","submit .fav-add":"addFavorite","click .fav-add-submit":"toggleFavorite","blur .fav-add-name":"addFavorite"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.favorites=this.options.favorites,this.template=_.template($("#info-tpl").html()),this.forum=this.options.forum||!1,this.listenTo(this.character.model,"change:total_cost",this.render),this.listenTo(this.favorites,"change add remove",this.render)},render:function(){var a=this.model.toJSON();return a.forum=this.forum,a.favorite=this.favorites.findWhere({hash:window.location.hash.substr(1)}),a.favorite&&(a.favorite=a.favorite.toJSON()),this.$el.html(this.template(a)),leiminauts.ev.trigger("update-specific-links"),this},focusForumSnippet:function(){this.$(".forum-snippet").select()},getFavoriteData:function(){return{hash:window.location.hash.substr(1),name:this.$(".fav-add-name").val(),character:_(this.character.model.toJSON()).pick("name","icon")}},toggleFavorite:function(a){a.preventDefault(),leiminauts.ev.trigger("toggle-favorite",this.getFavoriteData())},addFavorite:function(a){a.preventDefault(),leiminauts.ev.trigger("add-favorite",this.getFavoriteData())}}),leiminauts.SkillView=Backbone.View.extend({tagName:"div",className:"skill-wrapper",events:{"mouseover .skill-icon":"handleTooltip","mouseout .skill-icon":"handleTooltip","click .skill-icon":"toggleState","click .skill-cancel":"reset"},initialize:function(){this.forum=this.options.forum||!1,this.upgrades=[],this.model.get("upgrades").each(function(a){this.upgrades.push(new leiminauts.UpgradeView({model:a,forum:this.forum}))},this),this.template=_.template($("#build-skill-tpl").html()),this.listenTo(this.model.get("upgrades"),"change",this.renderUpgradesInfo),this.listenTo(this.model,"change",this.render)},toggleState:function(){return this.forum?!1:(this.model.setActive(!this.model.get("active")),void 0)},reset:function(){this.model.setActive(!1),this.model.get("toggable")||this.model.resetUpgradesState(!1)},render:function(){var a=this.model.toJSON();return a.forum=this.forum,this.$el.html()?(this.$(".skill").toggleClass("active",a.active),this.$(".skill").toggleClass("skill-maxed-out",a.maxed_out),this.$(".skill-effects").toggleClass("hidden",!a.effects.length),this.$(".skill-cancel").toggleClass("active",a.toggable&&a.active||a.upgrades.where({active:!0}).length>0),_(this.upgrades).invoke("delegateEvents")):(this.$el.html(this.template(a)),_(this.upgrades).each(function(a){a.delegateEvents(),this.$(".skill-upgrades").append(a.render().el)},this)),this.renderUpgradesInfo(),this},renderUpgradesInfo:function(){var a=this.model.toJSON();a.forum=this.forum,this.$(".skill-effects").html(_.template($("#build-skill-effects-tpl").html(),a))},handleTooltip:function(a){"mouseout"!=a.type?MouseTooltip.show(this.$(".skill-popup").html()):MouseTooltip.hide()}}),leiminauts.UpgradeView=Backbone.View.extend({tagName:"div",className:"upgrade",events:{mouseover:"handleTooltip",mouseout:"handleTooltip",click:"onClick"},initialize:function(){this.template=_.template($("#build-upgrade-tpl").html()),this.forum=this.options.forum||!1,this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),_(["active","locked"]).each(function(a){this.$el.toggleClass(a,this.model.get(a))},this),this},onClick:function(a){return this.forum?!1:(this.updateStep(),this.handleTooltip(a),void 0)},handleTooltip:function(a){"mouseover"==a.type?MouseTooltip.show(this.$(".upgrade-popup").html()):"click"==a.type?MouseTooltip.html(this.$(".upgrade-popup").html()):MouseTooltip.hide()},updateStep:function(){if(this.model.get("locked")){var a=this.model.get("skill");if(a&&(!_.isObject(a)||a.get("active")))return!1;a&&a.setActive(!0)}var b=this.model.get("current_step")?this.model.get("current_step").get("level"):0;b>=this.model.get("max_step")?this.model.setStep(0):this.model.setStep(b+1)}}),leiminauts.FavoritesView=Backbone.View.extend({className:"favorites-list-container",events:{"click .fav-delete":"deleteFavorite","click .favs-share textarea":"focusList","change .favs-share-switch":"render"},initialize:function(){return Modernizr.localstorage?(this.template=_.template($("#favs-tpl").html()),this.listenTo(this.collection,"add remove reset",this.render),this.characters=new leiminauts.CharactersView({collection:this.options.characters,console:this.options.console,mini:!0}),void 0):!1},render:function(){var a=this.collection.toJSON(),b=this.$(".favs-share-switch").val()||"forum",c=_.template($("#favs-list-"+b+"-tpl").html(),{favorites:a,root:leiminauts.root});return this.$el.html(this.template({favorites:a,favoritesText:c})),this.assign(this.characters,".chars"),this.$(".favs-share-switch").val(b),this},focusList:function(){this.$(".favs-share textarea").select()},deleteFavorite:function(a){var b=$(a.currentTarget).siblings(".fav-name").attr("href").substr(1),c=this.collection.findWhere({hash:b});c&&this.collection.removeFromStorage(c)}}),leiminauts.App=Backbone.Router.extend({routes:{"(console)":"charactersList",favorites:"favoritesList",":naut(/:build)(/:order)(/console)(/forum)(/)":"buildMaker"},initialize:function(a){leiminauts.ev=_({}).extend(Backbone.Events),leiminauts.root=window.location.host,void 0!==a.data&&(this.data=new leiminauts.CharactersData(null,{data:a.data,console:a.console}),this.data.on("selected",function(a){this.navigate(a,{trigger:!0})},this)),this.$el=$(a.el),this.favorites=new leiminauts.Favorites,this.console=a.console,$("html").toggleClass("console",this.console),this._beforeRoute(),this.grid=[],this.forum=a.forum,this.handleEvents()},handleEvents:function(){leiminauts.ev.on("toggle-favorite",function(a){this.favorites.toggle(a)},this),leiminauts.ev.on("add-favorite",function(a){this.favorites.addToStorage(a)},this),leiminauts.ev.on("update-specific-links",this.updateSpecificLinks,this)},_beforeRoute:function(){var a=this.getCurrentUrl(),b=void 0!==this.console?this.console:void 0,c=void 0!==this.forum?this.forum:void 0;this.console=-1!==a.indexOf("console"),this.forum=-1!==a.indexOf("/forum"),b!==this.console&&window.location.reload(),c!==this.forum&&$("html").toggleClass("forum",this.forum)},updateSpecificLinks:function(){var a=this.getCurrentUrl();$(".console-button a").attr("href","/#"+(-1!==a.indexOf("console")?a.replace("console",""):a+"/console"));var b="[build]"+window.location.hash.substr(1)+"[/build]";$(".forum-snippet").val(b),$(".website-url").attr("href",window.location.href.replace("/forum",""))},charactersList:function(){this._beforeRoute(),$("html").removeClass("page-blue").addClass("page-red");var a=new leiminauts.CharactersView({collection:this.data,console:this.console});this.showView(a),this.updateSpecificLinks()},favoritesList:function(){this._beforeRoute(),$("html").addClass("page-blue").removeClass("page-red");var a=new leiminauts.FavoritesView({collection:this.favorites,characters:this.data,console:this.console});this.showView(a),this.updateSpecificLinks()},buildMaker:function(a){if(!_.isNaN(parseInt(a,10)))return!1;if(this._beforeRoute(),"Skolldir"==a&&(a="Skølldir"),a=_.ununderscored(a).toLowerCase(),this.currentView&&this.currentView instanceof leiminauts.CharacterView&&this.currentView.model&&this.currentView.model.get("name").toLowerCase()==a)return this.updateBuildFromUrl(),this.updateSpecificLinks(),!0;$("html").addClass("page-blue").removeClass("page-red");var b=this.data.filter(function(b){var c=b.get("name").toLowerCase()==a;return b.set("selected",c),c});if(!b.length)return!1;b=b[0],b.reset();var c=new leiminauts.CharacterView({collection:this.data,favorites:this.favorites,model:b,console:this.console,forum:this.forum});this.showView(c),this._initGrid(),this.updateBuildFromUrl();var d=_.debounce(_.bind(this.updateBuildUrl,this),500);this.stopListening(b.get("skills"),"change"),this.listenTo(b.get("skills"),"change",d),c.on("order:changed",d,this),c.on("order:toggled",d,this),this.updateSpecificLinks()},showView:function(a){return this.currentView&&this.currentView.remove(),this.$el.html(a.render().el),this.currentView=a,a},updateBuildFromUrl:function(){if(!(this.currentView instanceof leiminauts.CharacterView))return!1;charView=this.currentView;var a=charView.model,b=this.getCurrentUrl(),c=b.split("/"),d=c.length>1?c[1]:null,e=c.length>2&&!_(["forum","console"]).contains(c[2])?c[2]:null;if(null===d)return a.reset(),!1;for(var f=null,g=0;28>g;g++)if(0===g%7)f=a.get("skills").at(g/7),f.setActive("1"===d.charAt(g));else if(f){var h=f.get("upgrades").at(g%7-1);h&&h.setStep(d.charAt(g))}if(e){var i=this._initGrid(),j=e.split("-"),k=_(j).countBy(function(a){return a}),l={},m=[];_(j).each(function(a){var b=i[a-1];b instanceof leiminauts.Skill&&m.push(b),b instanceof leiminauts.Upgrade&&(k[a]>1||l[a]?(l[a]=l[a]?l[a]+1:1,k[a]=k[a]-1,m.push(b.get("steps").at(l[a]))):l[a]||m.push(b.get("steps").at(1)))
}),charView.order.collection.reset(m,{sort:!1})}else charView.order.toggle()},updateBuildUrl:function(){if(!(this.currentView instanceof leiminauts.CharacterView))return!1;charView=this.currentView;var a=charView.model,b=charView.order.active?charView.order.collection:null,c="",d=[],e="",f=[];a.get("skills").each(function(a){c+=a.get("active")?"1":"0",f.push(a),a.get("upgrades").each(function(a){f.push(a),c+=a.get("current_step").get("level")})}),b&&b.length>0&&(b.each(function(a){if(a instanceof leiminauts.Skill)d.push(_(f).indexOf(a)+1);else if(a instanceof leiminauts.Step){var b=_(f).filter(function(b){return b instanceof leiminauts.Upgrade&&b.get("name")==a.get("upgrade").name});b=b?b[0]:!1,b&&d.push(_(f).indexOf(b)+1)}}),e="/"+d.join("-"));var g=this.getCurrentUrl(),h="";if(-1===g.indexOf("/"))h=g+"/"+c+e;else{h=g.substring(0,g.indexOf("/")+1)+c+e;var i=["/forum","/console"];_(i).each(function(a){-1!==g.indexOf(a)&&(h+=a)})}this.navigate(h),this.updateSpecificLinks()},getCurrentUrl:function(){return _(window.location.hash.substring(1)).trim("/").replace("ø","o")},_initGrid:function(){if(this.currentView instanceof leiminauts.CharacterView&&this.grid.length>0&&this.gridChar==this.currentView.model.get("name"))return this.grid;var a=[];this.currentView.model.get("skills").each(function(b){a.push(b),b.get("upgrades").each(function(b){a.push(b)})}),this.gridChar=this.currentView.model.get("name"),this.grid=a}}),$(function(){FastClick.attach(document.body),MouseTooltip.init({"3d":!1}),$("html").toggleClass("page-red",!window.location.hash.length)}),function(){var a=-1!==window.location.hash.indexOf("forum"),b=-1!==window.location.hash.indexOf("console"),c="localhost"===window.location.hostname,d=!0;leiminauts.sheets=[{name:"steam",key:"0AuPP-DBESPOedF9hckdzMWVhc2c3Rkk1R2RTa1pUdWc"},{name:"dev",key:"0AuPP-DBESPOedHBBU1FCcWl2ZTZDSUdwM0JPcW0wV2c"},{name:"conso",key:"0AuPP-DBESPOedHJTeGo4QUZsY0hiUThaRWg1eUJrZFE"}];var e=_(leiminauts.sheets).findWhere({name:c?"dev":b?"conso":"steam"});leiminauts.spreadsheet=e,leiminauts.init=function(c){c=c||{},_.defaults(c,{el:"#container",data:!1,console:b,forum:a}),window.nautsbuilder=new leiminauts.App(c),Backbone.history.start({pushState:!1})};var f=function(a){return"./data/"+e.name+"-"+a+".json"},g=function(){$.when($.ajax({url:f("characters"),dataType:"json"}),$.ajax({url:f("upgrades"),dataType:"json"}),$.ajax({url:f("skills"),dataType:"json"})).done(function(a,b,c){var f={characters:a[0],skills:c[0],upgrades:b[0]};Modernizr.localstorage&&d&&(localStorage.setItem("nautsbuilder."+e.name+".characters",JSON.stringify(f.characters)),localStorage.setItem("nautsbuilder."+e.name+".skills",JSON.stringify(f.skills)),localStorage.setItem("nautsbuilder."+e.name+".upgrades",JSON.stringify(f.upgrades)),localStorage.setItem("nautsbuilder."+e.name+".date",(new Date).getTime())),leiminauts.init({data:f})})};if(leiminauts.lastServerDataUpdate=leiminauts.lastServerDataUpdate||0,leiminauts.localDate=Modernizr.localstorage&&localStorage.getItem("nautsbuilder."+e.name+".date")?localStorage.getItem("nautsbuilder."+e.name+".date"):0,!d||0===leiminauts.lastServerDataUpdate||leiminauts.lastServerDataUpdate>leiminauts.localDate)g();else{var h=!0;if(Modernizr.localstorage){var i=localStorage.getItem("nautsbuilder."+e.name+".characters"),j=localStorage.getItem("nautsbuilder."+e.name+".skills"),k=localStorage.getItem("nautsbuilder."+e.name+".upgrades");if(_([i,j,k]).each(function(a){return a&&"undefined"!==a?void 0:(h=!1,!1)}),h){var l={};l.characters=JSON.parse(localStorage.getItem("nautsbuilder."+e.name+".characters")),l.skills=JSON.parse(localStorage.getItem("nautsbuilder."+e.name+".skills")),l.upgrades=JSON.parse(localStorage.getItem("nautsbuilder."+e.name+".upgrades")),leiminauts.init({data:l})}}Modernizr.localstorage&&h||g()}}(),function(){var a=leiminauts.lastServerDataUpdate<leiminauts.lastSpreadsheetUpdate;if(a||(a=(new Date).getTime()-leiminauts.lastServerDataUpdate>1728e5),a){$(".data-update-button").length&&$(".data-update-button").attr("disabled","disabled");var b={steam:"0AuPP-DBESPOedF9hckdzMWVhc2c3Rkk1R2RTa1pUdWc",dev:"0AuPP-DBESPOedHBBU1FCcWl2ZTZDSUdwM0JPcW0wV2c",conso:"0AuPP-DBESPOedHJTeGo4QUZsY0hiUThaRWg1eUJrZFE"},c=_(b).keys(),d=function(a,b,c){var d=JSON.stringify(c.sheets("Characters").all()),e=JSON.stringify(c.sheets("Skills").all()),g=JSON.stringify(c.sheets("Upgrades").all()),h={sheet:a,characters:d,skills:e,upgrades:g};$.ajax({type:"POST",url:"../../../data/update.php",data:h,complete:f})},e=function(a){a=a||"",$(".data-updated-notice").length&&$(".data-updated-notice").html(a)},f=_.after(c.length,function(){e('The <a href="/">Nautsbuilder</a>\'s data is now up-to-date!')});e("Updating data...");for(var g=c.length-1;g>=0;g--){var h=c[g];!function(a){Tabletop.init({key:b[a],debug:!0,callback:function(b,c){d(a,b,c)}})}(h)}}}();